{"version":3,"sources":["../src/webpack-yam-plugin.js"],"names":[],"mappings":"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","file":"webpack-yam-plugin.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\nimport transform from 'lodash/object/transform';\nimport stripAnsi from 'strip-ansi';\n\n/*\nWebpack plugin that emits a manifest file in the following format\n\n{\n  status: \"built\" || \"building\" || \"errors\",\n  errors: null || [\n    \"<error text>\",\n    ...\n  ],\n  files: null || {\n    <entry>: [\n      'rel/path/to/file.ext',\n      ...\n    ],\n    ...\n  }\n}\n */\n\nfunction WebpackYAMPlugin({manifestPath, outputRoot}) {\n  if (!manifestPath) throw new Error('WebpackYAMPlugin: no `manifestPath` option provided. It should be an absolute path to a file');\n  if (!outputRoot) throw new Error('WebpackYAMPlugin: no `outputRoot` option provided. It should be an absolute path that your assets are served from');\n\n  this.manifestPath = manifestPath;\n  this.outputRoot = outputRoot;\n}\n\nWebpackYAMPlugin.prototype.apply = function(compiler) {\n  const manifestPath = this.manifestPath;\n  const outputRoot = this.outputRoot;\n\n  if (!compiler.options.output.path) throw new Error('WebpackYAMPlugin: no `output.path` defined in config');\n  const outputPath = compiler.options.output.path;\n\n  compiler.plugin('compile', (compiler, callback) => {\n    emitManifest({\n      manifestPath,\n      status: 'building'\n    });\n  });\n\n  compiler.plugin('done', (stats) => {\n    if (stats.hasErrors()) {\n      emitManifest({\n        manifestPath,\n        status: 'errors',\n        errors: stats.toJson().errors.map(err => stripAnsi(err))\n      });\n    } else {\n      emitManifest({\n        manifestPath,\n        status: 'built',\n        files: transform(stats.compilation.chunks, (files, chunk) => {\n          files[chunk.name] = chunk.files.map(file => {\n            const absPath = path.join(outputPath, file);\n            const relPath = absPath.slice(outputRoot.length);\n            if (relPath[0] == path.sep) {\n              return relPath.slice(1);\n            }\n            return relPath;\n          });\n        }, {})\n      });\n    }\n  });\n};\n\nfunction emitManifest({manifestPath, status, errors=null, files=null}) {\n  if (!manifestPath) throw new Error('WebpackYAMPlugin: no `manifestPath` provided in call to emitManifest');\n  if (!status) throw new Error('WebpackYAMPlugin: no `status` provided in call to emitManifest');\n\n  const manifest = JSON.stringify({\n    status,\n    errors,\n    files\n  }, null, 2);\n\n  mkdirp(path.dirname(manifestPath), function(err) {\n    if (err) throw err;\n\n    fs.writeFile(manifestPath, manifest, function(err) {\n      if (err) throw err;\n    });\n  });\n}\n\nmodule.exports = WebpackYAMPlugin;"]}